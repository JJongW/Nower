name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  create-release:
    runs-on: macos-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Get version from tag
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
      
      - name: Extract changelog
        id: changelog
        run: |
          # CHANGELOG.mdì—ì„œ í•´ë‹¹ ë²„ì „ì˜ ë³€ê²½ì‚¬í•­ ì¶”ì¶œ
          VERSION=${{ steps.get_version.outputs.VERSION }}
          CHANGELOG=$(awk -v ver="$VERSION" '
            /^## \['"$VERSION"'\]/ {flag=1; next}
            /^## \[/ {flag=0}
            flag && NF
          ' CHANGELOG.md)
          
          # ë©€í‹°ë¼ì¸ ì¶œë ¥ì„ ìœ„í•œ ì²˜ë¦¬
          echo "CHANGELOG<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          body: |
            ## Nower v${{ steps.get_version.outputs.VERSION }}
            
            ${{ steps.changelog.outputs.CHANGELOG }}
            
            ---
            
            ### ë‹¤ìš´ë¡œë“œ
            - iOS ì•±ì€ App Storeì—ì„œ ë‹¤ìš´ë¡œë“œí•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            - macOS ì•±ì€ ì•„ë˜ Assetsì—ì„œ ë‹¤ìš´ë¡œë“œí•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            
            ### ì„¤ì¹˜ ë°©ë²•
            #### iOS
            1. TestFlight ë˜ëŠ” App Storeì—ì„œ ì„¤ì¹˜
            
            #### macOS
            1. DMG íŒŒì¼ ë‹¤ìš´ë¡œë“œ
            2. ì• í”Œë¦¬ì¼€ì´ì…˜ í´ë”ë¡œ ë“œë˜ê·¸
            
            ì „ì²´ ë³€ê²½ ì‚¬í•­ì€ [CHANGELOG.md](https://github.com/JJongW/Nower/blob/main/CHANGELOG.md)ì—ì„œ í™•ì¸í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
          draft: false
          prerelease: ${{ contains(steps.get_version.outputs.VERSION, 'beta') || contains(steps.get_version.outputs.VERSION, 'alpha') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Notify completion
        run: |
          echo "âœ… Release v${{ steps.get_version.outputs.VERSION }} created successfully!"
          echo "ğŸ”— https://github.com/JJongW/Nower/releases/tag/v${{ steps.get_version.outputs.VERSION }}"
